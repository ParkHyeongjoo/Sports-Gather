<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.opennote.booster.attachment.repository.AttachmentRepository">

    <select id="getList" parameterType="String" resultType="attachment">
        SELECT
            REGR_ID,
            REG_DT,
            UPDR_ID,
            UPD_DT,
            ATFL_ID,
            FILE_SEQ_NO,
            PHCL_FILE_PATH_NM,
            PHCL_FILE_NM,
            FILE_RL_NM,
            FILE_EXT_NM,
            ROUND(FILE_SIZE_VAL / 1024 / 1024, 1) fileSizeVal,
            FILE_TP_NM,
            USE_YN,
            THMB_FILE_NM
        FROM T_ATCH_FILE_DETAIL
        WHERE ATFL_ID = #{atflId}
        AND USE_YN = 'Y'
        ORDER BY FILE_SEQ_NO
    </select>

    <select id="get" parameterType="attachment" resultType="attachment">
        SELECT
            REGR_ID,
            REG_DT,
            UPDR_ID,
            UPD_DT,
            ATFL_ID,
            FILE_SEQ_NO,
            PHCL_FILE_PATH_NM,
            PHCL_FILE_NM,
            FILE_RL_NM,
            FILE_EXT_NM,
            ROUND(FILE_SIZE_VAL / 1024 / 1024, 1) fileSizeVal,
            FILE_TP_NM,
            USE_YN,
            THMB_FILE_NM
        FROM T_ATCH_FILE_DETAIL
        WHERE ATFL_ID = #{atflId}
            AND FILE_SEQ_NO = #{fileSeqNo}
            AND PHCL_FILE_NM = #{phclFileNm}
            AND USE_YN = 'Y'
    </select>

    <insert id="post" parameterType="attachment">
        <selectKey resultType="java.lang.String" keyProperty="fileSeqNo" order="BEFORE">
            SELECT NVL(MAX(D.FILE_SEQ_NO), 0) + 1 FROM T_ATCH_FILE_DETAIL D WHERE D.ATFL_ID = #{atflId}
        </selectKey>
        INSERT INTO T_ATCH_FILE_DETAIL(
            REGR_ID,
            ATFL_ID,
            FILE_SEQ_NO,
            PHCL_FILE_PATH_NM,
            PHCL_FILE_NM,
            FILE_RL_NM,
            FILE_EXT_NM,
            FILE_SIZE_VAL,
            FILE_TP_NM,
            THMB_FILE_NM
        ) VALUES (
            #{regrId},
            #{atflId},
            #{fileSeqNo},
            #{phclFilePathNm},
            #{phclFileNm},
            #{fileRlNm},
            #{fileExtNm},
            #{fileSizeVal},
            #{fileTpNm},
            #{thmbFileNm}
        )
    </insert>

    <delete id="delete" parameterType="attachment">
        DELETE
        FROM T_ATCH_FILE_DETAIL
        WHERE ATFL_ID = #{atflId}
            AND FILE_SEQ_NO = #{fileSeqNo}
            AND PHCL_FILE_NM = #{phclFileNm}
            AND USE_YN = 'Y'
    </delete>
</mapper>